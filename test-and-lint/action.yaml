name: "Build and Push Docker"
description: "Build a container image and Pushes it to Docker registry"

runs:
  using: "composite"
  steps:
  - uses: actions/checkout@v2
  - uses: actions/setup-python@v2
    with:
      python-version: 3.9.6

  - name: Install poetry
    uses: snok/install-poetry@v1.2.0
    with:
      version: 1.1.8
      virtualenvs-create: true
      virtualenvs-in-project: true
      
  - name: Load cached venv
    id: cached-poetry-dependencies
    uses: actions/cache@v2
    with:
      path: .venv
      key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
      
  - name: Install dependencies
    shell: bash
    run: poetry install
    if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'

  - name: Code Formatting
    shell: bash
    run: |
      poetry run black --config ./pyproject.toml --check app tests

  - name: Create results directory
    shell: bash
    run: |-
      mkdir results

  - name: Run Tests
    shell: bash
    run: |
      poetry run pytest ./tests --junitxml=./results/result.xml
      poetry run coverage run --rcfile ./pyproject.toml -m pytest ./tests
      poetry run coverage report -m > ./results/coverage.txt
      
  - name: Archive code coverage results
    uses: actions/upload-artifact@v2
    with:
      name: code-coverage-report
      path: results